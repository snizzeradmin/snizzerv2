<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Snizzer Leaks Admin</title>
    <!-- TailwindCSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-storage-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <style>
        body { font-family: sans-serif; }
    </style>
</head>
<body class="bg-gray-900 text-gray-100 min-h-screen flex items-center justify-center">
    <div class="bg-gray-800 p-8 rounded-lg shadow-lg w-full max-w-md">
        <h1 class="text-3xl font-bold text-center mb-6">Add New Video</h1>
        <form id="uploadForm" class="space-y-4">
            <div>
                <label for="videoTitle" class="block text-sm font-medium text-gray-300">Video Title</label>
                <input type="text" id="videoTitle" class="mt-1 block w-full p-3 rounded-md bg-gray-700 border border-gray-600 focus:ring focus:ring-blue-500 focus:border-blue-500" required>
            </div>
            <div>
                <label for="videoUrl" class="block text-sm font-medium text-gray-300">Video URL</label>
                <input type="url" id="videoUrl" class="mt-1 block w-full p-3 rounded-md bg-gray-700 border border-gray-600 focus:ring focus:ring-blue-500 focus:border-blue-500" required placeholder="https://example.com/video.mp4">
            </div>
            <div>
                <label for="thumbnailUrl" class="block text-sm font-medium text-gray-300">Thumbnail URL (Optional)</label>
                <input type="url" id="thumbnailUrl" class="mt-1 block w-full p-3 rounded-md bg-gray-700 border border-gray-600 focus:ring focus:ring-blue-500 focus:border-blue-500" placeholder="https://example.com/thumbnail.jpg">
            </div>
            <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-md transition duration-300">Add Video</button>
            <div id="uploadProgress" class="w-full bg-gray-700 rounded-full h-2.5 dark:bg-gray-700 hidden">
                <div class="bg-blue-600 h-2.5 rounded-full" style="width: 0%"></div>
            </div>
            <p id="uploadStatus" class="text-center text-sm mt-2"></p>
        </form>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyDArLK_DvLfGk7cZ4gCjPZg1UgW-ClIu9M",
            authDomain: "snizzerleaks.firebaseapp.com",
            projectId: "snizzerleaks",
            storageBucket: "snizzerleaks.firebasestorage.app",
            messagingSenderId: "392238282125",
            appId: "1:392238282125:web:d216f6aa64e6ffb946f9c4",
            measurementId: "G-VR1FCDNRQF"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const storage = firebase.storage();
        const db = firebase.firestore();

        document.getElementById('uploadForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const videoTitle = document.getElementById('videoTitle').value;
            const videoUrl = document.getElementById('videoUrl').value;
            const thumbnailUrl = document.getElementById('thumbnailUrl').value;
            const uploadStatus = document.getElementById('uploadStatus');
            const uploadProgress = document.getElementById('uploadProgress');
            const progressBar = uploadProgress.querySelector('div');

            if (!videoUrl) {
                uploadStatus.textContent = 'Please enter a video URL.';
                uploadStatus.className = 'text-center text-sm mt-2 text-red-500';
                return;
            }

            uploadProgress.classList.remove('hidden');
            uploadStatus.textContent = 'Processing...';
            uploadStatus.className = 'text-center text-sm mt-2 text-gray-300';
            progressBar.style.width = '0%';

            try {
                let finalThumbnailURL = thumbnailUrl;
                if (!thumbnailUrl) {
                    // Generate thumbnail from video URL if no thumbnail URL is provided
                    uploadStatus.textContent = 'Generating thumbnail from video...';
                    finalThumbnailURL = await generateThumbnailFromVideoUrl(videoUrl);
                    uploadStatus.textContent = 'Generated thumbnail from video.';
                }

                // Save video metadata to Firestore
                await db.collection('videos').add({
                    title: videoTitle,
                    videoURL: videoUrl,
                    thumbnailURL: finalThumbnailURL,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                });

                uploadStatus.textContent = 'Video added successfully!';
                uploadStatus.className = 'text-center text-sm mt-2 text-green-500';
                document.getElementById('uploadForm').reset();
                uploadProgress.classList.add('hidden');

            } catch (error) {
                console.error('Process failed:', error);
                uploadStatus.textContent = `Process failed: ${error.message}`;
                uploadStatus.className = 'text-center text-sm mt-2 text-red-500';
                uploadProgress.classList.add('hidden');
            }
        });

        async function generateThumbnailFromVideoUrl(videoUrl) {
            return new Promise((resolve, reject) => {
                const video = document.createElement('video');
                video.crossOrigin = 'anonymous'; // Enable CORS for the video
                video.src = videoUrl;
                video.currentTime = 1; // Capture frame at 1 second
                video.autoplay = false;
                video.muted = true;
                video.playsInline = true;

                video.onloadeddata = async () => {
                    try {
                        const canvas = document.createElement('canvas');
                        canvas.width = video.videoWidth;
                        canvas.height = video.videoHeight;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

                        const blob = await new Promise(resolve => canvas.toBlob(resolve, 'image/png'));
                        const thumbnailRef = storage.ref('thumbnails/thumbnail_' + Date.now() + '.png');
                        const thumbnailUploadTask = thumbnailRef.put(blob);
                        await thumbnailUploadTask;
                        const thumbnailURL = await thumbnailUploadTask.snapshot.ref.getDownloadURL();
                        resolve(thumbnailURL);
                    } catch (error) {
                        reject(error);
                    }
                };

                video.onerror = () => {
                    console.error('Error loading video for thumbnail generation.');
                    resolve('https://via.placeholder.com/300x180?text=No+Thumbnail'); // Fallback
                };
            });
        }
    </script>
</body>
</html>
